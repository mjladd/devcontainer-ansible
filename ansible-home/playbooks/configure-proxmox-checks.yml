---
- name: Create custom Proxmox storage metrics script
  copy:
    content: |
      #!/bin/bash
      # Script to collect Proxmox storage metrics and send to Datadog

      for storage in $(pvesm status | tail -n +2 | awk '{print $1}'); do
        # pvesm status output format: Name Type Status Total Used Available %
        # We need Total (field 4), Used (field 5), Available (field 6)

        TOTAL=$(pvesm status | grep "^${storage}" | awk '{print $4}')
        USED=$(pvesm status | grep "^${storage}" | awk '{print $5}')
        AVAIL=$(pvesm status | grep "^${storage}" | awk '{print $6}')

        # Send metrics via DogStatsD
        echo "proxmox.storage.${storage}.total:${TOTAL}|g|#storage:${storage}" | nc -u -w1 localhost 8125
        echo "proxmox.storage.${storage}.used:${USED}|g|#storage:${storage}" | nc -u -w1 localhost 8125
        echo "proxmox.storage.${storage}.available:${AVAIL}|g|#storage:${storage}" | nc -u -w1 localhost 8125
      done
    dest: /usr/local/bin/datadog-proxmox-storage-metrics.sh
    owner: root
    group: root
    mode: '0755'
