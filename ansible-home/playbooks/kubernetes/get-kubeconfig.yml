---
# Playbook to retrieve kubeconfig from control plane
# Usage: ansible-playbook -i inventory/inventory.ini playbooks/get-kubeconfig.yml
#
# This will save the kubeconfig to ./kubeconfig in the current directory

- name: Retrieve kubeconfig from control plane
  hosts: k8s_control_plane
  become: yes
  tasks:
    - name: Fetch kubeconfig from control plane
      fetch:
        src: /etc/kubernetes/admin.conf
        dest: ./kubeconfig
        flat: yes

    - name: Get control plane IP
      set_fact:
        control_plane_ip: "{{ ansible_default_ipv4.address }}"

- name: Display kubeconfig information
  hosts: localhost
  gather_facts: no
  tasks:
    - name: Show kubeconfig location
      debug:
        msg:
          - "==========================================="
          - "Kubeconfig retrieved successfully!"
          - "==========================================="
          - ""
          - "The kubeconfig file has been saved to:"
          - "  {{ playbook_dir }}/../kubeconfig"
          - ""
          - "To use it:"
          - "  export KUBECONFIG={{ playbook_dir }}/../kubeconfig"
          - "  kubectl get nodes"
          - ""
          - "Or copy it to your default location:"
          - "  mkdir -p ~/.kube"
          - "  cp {{ playbook_dir }}/../kubeconfig ~/.kube/config"
          - "==========================================="
