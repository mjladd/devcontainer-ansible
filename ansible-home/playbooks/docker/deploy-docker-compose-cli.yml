---
- name: Deploy and start Docker Compose application (CLI method)
  hosts: docker_servers
  become: yes

  vars:
    # Define the source docker-compose file path (on control node)
    compose_file_src: "docker-compose-ollama.yml"
    # Define the destination directory on the target host
    compose_dest_dir: "/opt/docker-compose-app"
    # Define the project name (optional, defaults to directory name)
    compose_project_name: "ollama"

  tasks:
    - name: Ensure Docker service is running
      systemd:
        name: docker
        state: started
        enabled: yes

    - name: Create destination directory for docker-compose
      file:
        path: "{{ compose_dest_dir }}"
        state: directory
        mode: '0755'

    - name: Copy docker-compose.yml to target host
      copy:
        src: "{{ compose_file_src }}"
        dest: "{{ compose_dest_dir }}/docker-compose.yml"
        mode: '0644'
      register: compose_file_changed

    - name: Copy environment file if exists
      copy:
        src: "{{ item }}"
        dest: "{{ compose_dest_dir }}/"
        mode: '0644'
      with_fileglob:
        - ".env"
        - "*.env"
      ignore_errors: yes

    - name: Pull Docker images
      command: docker compose pull
      args:
        chdir: "{{ compose_dest_dir }}"
      environment:
        COMPOSE_PROJECT_NAME: "{{ compose_project_name }}"

    - name: Stop and remove existing containers (if compose file changed)
      command: docker compose down
      args:
        chdir: "{{ compose_dest_dir }}"
      environment:
        COMPOSE_PROJECT_NAME: "{{ compose_project_name }}"
      when: compose_file_changed.changed

    - name: Start Docker Compose services
      command: docker compose up -d
      args:
        chdir: "{{ compose_dest_dir }}"
      environment:
        COMPOSE_PROJECT_NAME: "{{ compose_project_name }}"
      register: compose_up_result

    - name: Wait for containers to be healthy
      pause:
        seconds: 5

    - name: Check container status
      command: docker compose ps
      args:
        chdir: "{{ compose_dest_dir }}"
      environment:
        COMPOSE_PROJECT_NAME: "{{ compose_project_name }}"
      register: compose_ps_output
      changed_when: false

    - name: Display container status
      debug:
        var: compose_ps_output.stdout_lines

    - name: Get container logs (last 20 lines)
      command: docker compose logs --tail=20
      args:
        chdir: "{{ compose_dest_dir }}"
      environment:
        COMPOSE_PROJECT_NAME: "{{ compose_project_name }}"
      register: compose_logs
      changed_when: false

    - name: Display recent logs
      debug:
        var: compose_logs.stdout_lines
